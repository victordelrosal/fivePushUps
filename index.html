<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Push-ups & Squats Accountability</title>
<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f0f8ff;
    padding: 20px;
}
h2 {
    color: #1e90ff;
}
.table-container {
    overflow-x: auto; /* Allow horizontal scrolling */
    -webkit-overflow-scrolling: touch; /* For smooth scrolling on iOS */
    position: relative;
}
table {
    border-collapse: collapse;
    margin-top: 20px;
    width: 100%;
    min-width: 800px; /* Ensures the table is wider than the viewport */
}
th, td {
    border: 2px solid #1e90ff;
    padding: 10px;
    text-align: center;
}
th {
    background-color: #1e90ff;
    color: white;
    position: sticky;
    top: 0;
    z-index: 1;
}
.completed {
    background-color: #90ee90;
}
.timestamp {
    font-size: 0.8em;
    color: #666;
    margin-top: 5px;
}
.not-checked {
    cursor: pointer;
}
th:first-child,
td:first-child {
    position: sticky;
    left: 0;
    background-color: #f0f8ff;
    z-index: 2;
}
th:first-child {
    z-index: 3;
    background-color: #1e90ff; /* Change this to the desired background color */
    color: white; /* Add this to set the text color to white for better visibility */
}
img.streak-img {
    width: 50px;
    height: auto;
    cursor: pointer;
}
.modal {
    display: none;
    position: fixed;
    z-index: 1;
    padding-top: 100px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0, 0, 0);
    background-color: rgba(0, 0, 0, 0.9);
}
.modal-content {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
}
#caption {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
    text-align: center;
    color: #ccc;
    padding: 10px 0;
    height: 150px;
}
.modal-content, #caption {
    animation-name: zoom;
    animation-duration: 0.6s;
}
@keyframes zoom {
    from { transform: scale(0); }
    to { transform: scale(1); }
}
.close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    transition: 0.3s;
}
.close:hover,
.close:focus {
    color: #bbb;
    text-decoration: none;
    cursor: pointer;
}
/* Custom modal for confirmation */
.confirm-modal {
    display: none;
    position: fixed;
    z-index: 2;
    padding-top: 100px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}
.confirm-modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    text-align: center;
}
.confirm-modal-buttons {
    margin-top: 20px;
    text-align: center;
}
.confirm-modal-buttons button {
    padding: 10px 20px;
    margin: 0 10px;
    border: none;
    cursor: pointer;
    font-size: 1em;
}
.confirm-modal-buttons button.confirm {
    background-color: #1e90ff;
    color: white;
}
.confirm-modal-buttons button.cancel {
    background-color: #ccc;
}
</style>
</head>
<body>
<h2>5 Push-ups & 5 Squats a Day Self-Tracker</h2>

<div class="table-container">
<table id="pushup-tracker">
    <thead>
        <tr>
            <th>Player</th>
            <th>10-Day Streak</th>
            <th>30-Day Streak</th>
            <!-- Dates dynamically generated -->
        </tr>
    </thead>
    <tbody>
        <!-- Player rows dynamically generated -->
    </tbody>
</table>
</div>

<!-- The Modal -->
<div id="myModal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="img01">
    <div id="caption"></div>
</div>

<!-- Custom Confirm Modal -->
<div id="confirmModal" class="confirm-modal">
    <div class="confirm-modal-content">
        <p id="confirmMessage"></p>
        <div class="confirm-modal-buttons">
            <button class="confirm" id="confirmYes">Yes</button>
            <button class="cancel" id="confirmNo">No</button>
        </div>
    </div>
</div>

<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getFirestore, doc, setDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

// Define start and end dates as constants
const START_DATE = "2025-04-07";
const END_DATE = "2025-05-06";

// Your web app's Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyAtg-_5eLD-Prs74zTnCj4HjQQfnssdfP8",
    authDomain: "fivepushups-d5d82.firebaseapp.com",
    projectId: "fivepushups-d5d82",
    storageBucket: "fivepushups-d5d82.appspot.com",
    messagingSenderId: "472818589501",
    appId: "1:472818589501:web:ef6402c4e19842c0e86f54",
    measurementId: "G-TJ5VSMC86Y"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
console.log("Firebase initialized");

// Define a single, global players list
const players = [
    { name: "Aidan", idPrefix: "aidan" },
    { name: "Aileen", idPrefix: "aileen" },
    { name: "Aisling", idPrefix: "aisling" },
    { name: "Claire", idPrefix: "claire" },
    { name: "Colm", idPrefix: "colm" },
    { name: "Colin", idPrefix: "colin" },
    { name: "Gráinne", idPrefix: "grainne" },
    { name: "Helen", idPrefix: "helen" },
    { name: "Jamie", idPrefix: "jamie" },
    { name: "KatieG", idPrefix: "katieg" },
    { name: "KatieK", idPrefix: "katiek" },
    { name: "Leo", idPrefix: "leo" },
    { name: "Mark", idPrefix: "mark" },
    { name: "Michelle", idPrefix: "michelle" },
    { name: "PaulaD", idPrefix: "paulad" },
    { name: "Roisin", idPrefix: "roisin" },
    { name: "Tracey", idPrefix: "tracey" },
    { name: "Victor", idPrefix: "victor" },
    { name: "Wayne", idPrefix: "wayne" }
];

// Add a helper function for consistent date parsing
function parseDate(dateStr) {
    if (dateStr.includes('-')) { // e.g. "2025-04-07"
        const [year, month, day] = dateStr.split('-').map(Number);
        return new Date(year, month - 1, day);
    } else if (dateStr.includes('/')) { // e.g. "4/7/2025"
        const [month, day, year] = dateStr.split('/').map(Number);
        return new Date(year, month - 1, day);
    }
    return new Date(dateStr);
}

function confirmCheck(checkbox, name, dateString) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const checkDate = new Date(dateString);

    if (checkDate.toDateString() !== today.toDateString()) {
        alert("You can only check off today's date.");
        checkbox.checked = false;
        return;
    }

    showConfirmModal(name, dateString, () => {
        checkbox.disabled = true;

        const checkMark = document.createElement("span");
        checkMark.textContent = "✅";
        checkbox.parentElement.replaceChild(checkMark, checkbox);

        const timestamp = new Date().toLocaleString();
        const timestampElement = document.createElement("div");
        timestampElement.classList.add("timestamp");
        timestampElement.textContent = `Confirmed at: ${timestamp}`;
        checkMark.parentElement.appendChild(timestampElement);

        console.log(`${name} confirmed 5 push-ups on ${dateString} at ${timestamp}`);
        checkMark.parentElement.classList.add("completed");

        // Save to Firestore
        setDoc(doc(db, "pushups", `${name}_${dateString.replace(/\//g, '-')}`), {
            name: name,
            date: dateString,
            timestamp: timestamp
        }).then(() => {
            console.log("Data successfully written!");
        }).catch((error) => {
            console.error("Error writing document: ", error);
        });
    }, () => {
        checkbox.checked = false;
    });
}

function showConfirmModal(name, dateString, onConfirm, onCancel) {
    const confirmModal = document.getElementById("confirmModal");
    const confirmMessage = document.getElementById("confirmMessage");
    const confirmYes = document.getElementById("confirmYes");
    const confirmNo = document.getElementById("confirmNo");

    confirmMessage.textContent = `I, ${name}, confirm that I have completed five or more push-ups today, ${dateString}.`;

    confirmModal.style.display = "block";

    confirmYes.onclick = () => {
        onConfirm();
        confirmModal.style.display = "none";
    };

    confirmNo.onclick = () => {
        onCancel();
        confirmModal.style.display = "none";
    };
}

function generateDateRange(startDate, endDate) {
    const dates = [];
    const currentDate = parseDate(startDate);
    const end = parseDate(endDate);
    while (currentDate <= end) {
        const day = currentDate.getDate();
        const month = currentDate.getMonth() + 1;
        const year = currentDate.getFullYear();
        dates.push(`${month}/${day}/${year}`);
        currentDate.setDate(currentDate.getDate() + 1);
    }
    return dates;
}

function generateTable(startDate, endDate) {
    const table = document.getElementById("pushup-tracker");
    if (!table) {
        console.error("Table element not found");
        return;
    }

    // Common badge URLs for all players
    const badge10DayURL = "https://i.postimg.cc/vHDJ8GwG/10day-Streak-Victor.png";
    const badge30DayURL = "https://i.postimg.cc/KYgDzFX0/25day-Streak-Victor.png";
    
    const dates = generateDateRange(startDate, endDate);

    const headerRow = table.querySelector("thead tr");
    if (!headerRow) {
        console.error("Header row not found");
        return;
    }

    // Remove any existing "10-Day Streak" and "25-Day Streak" headers
    while (headerRow.children[1] && (headerRow.children[1].textContent === "10-Day Streak" || headerRow.children[1].textContent === "25-Day Streak" || headerRow.children[1].textContent === "30-Day Streak")) {
        headerRow.removeChild(headerRow.children[1]);
    }

    // Add streak column headers
    const streakHeader10 = document.createElement("th");
    streakHeader10.textContent = "10-Day Streak";
    headerRow.insertBefore(streakHeader10, headerRow.children[1]);

    const streakHeader30 = document.createElement("th");
    streakHeader30.textContent = "30-Day Streak";
    headerRow.insertBefore(streakHeader30, headerRow.children[2]);

    dates.forEach(date => {
        const parts = date.split("/");
        const formattedDate = `${parseInt(parts[1], 10)}/${parseInt(parts[0], 10)}`;
        const th = document.createElement("th");
        th.textContent = formattedDate;
        headerRow.appendChild(th);
    });

    const tbody = table.querySelector("tbody");
    if (!tbody) {
        console.error("Table body not found");
        return;
    }

    players.forEach(player => {
        const row = document.createElement("tr");
        const playerName = document.createElement("td");
        playerName.textContent = player.name;
        row.appendChild(playerName);

        const streakCell10 = document.createElement("td");
        streakCell10.id = `${player.idPrefix}-streak-10`;
        row.appendChild(streakCell10);

        const streakCell30 = document.createElement("td");
        streakCell30.id = `${player.idPrefix}-streak-30`;
        row.appendChild(streakCell30);

        dates.forEach(date => {
            const [month, day, year] = date.split("/");
            const checkboxId = `${player.idPrefix}-${month}-${day}-${year}`;
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = checkboxId;
            checkbox.onclick = () => confirmCheck(checkbox, player.name, date);
            const td = document.createElement("td");
            td.appendChild(checkbox);
            row.appendChild(td);
        });

        tbody.appendChild(row);
    });

    disableFutureDates();
    loadData();
    
    // Pass start and end date objects to checkStreaks normally using parseDate
    const startDateObj = parseDate(startDate);
    const endDateObj = parseDate(endDate);
    checkStreaks(startDateObj, endDateObj, badge10DayURL, badge30DayURL);
}

function disableFutureDates() {
    const today = new Date();
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');

    checkboxes.forEach(checkbox => {
        const [_, month, day, year] = checkbox.id.split("-");
        const checkDate = new Date(`${month}/${day}/${year}`);

        if (checkDate > today) {
            checkbox.disabled = true;
        }
    });
}

async function loadData() {
    try {
        const querySnapshot = await getDocs(collection(db, "pushups"));
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            const name = data.name;
            const date = data.date;
            const timestamp = data.timestamp;

            console.log("Loaded data:", data); // Debugging statement

            const formattedDate = date.replace(/\//g, '-');
            const checkboxId = `${name.toLowerCase()}-${formattedDate}`;
            console.log("Checkbox ID:", checkboxId); // Debugging statement

            const checkbox = document.getElementById(checkboxId);

            if (checkbox) {
                const checkMark = document.createElement("span");
                checkMark.textContent = "✅";
                checkbox.parentElement.replaceChild(checkMark, checkbox);

                const timestampElement = document.createElement("div");
                timestampElement.classList.add("timestamp");
                timestampElement.textContent = `Confirmed at: ${timestamp}`;
                checkMark.parentElement.appendChild(timestampElement);

                checkMark.parentElement.classList.add("completed");
            } else {
                console.error("Checkbox not found for ID:", checkboxId); // Debugging statement
            }
        });
        console.log("Data successfully loaded!");
    } catch (error) {
        console.error("Error loading data: ", error);
    }
}

async function checkStreaks(startDate, endDate, badge10URL, badge30URL) {
    try {
        const querySnapshot = await getDocs(collection(db, "pushups"));
        const pushupData = {};

        // Process Firestore data
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (!pushupData[data.name]) pushupData[data.name] = [];
            pushupData[data.name].push(data.date);
        });

        players.forEach(player => {
            const streakCell10 = document.getElementById(`${player.idPrefix}-streak-10`);
            const streakCell30 = document.getElementById(`${player.idPrefix}-streak-30`);
            
            // Clear previous badges
            streakCell10.innerHTML = '';
            streakCell30.innerHTML = '';

            // Process and filter dates
            const playerDates = pushupData[player.name] || [];
            const filteredDates = playerDates
                .map(dateStr => {
                    const [month, day, year] = dateStr.split('/').map(Number);
                    return new Date(year, month - 1, day);
                })
                .filter(date => {
                    // Add both start and end date constraints
                    return date >= startDate && date <= endDate;
                })
                .sort((a, b) => a - b);

            // Check streaks with filtered dates
            if (checkStreak(filteredDates, 10)) {
                const streakImg10 = document.createElement("img");
                streakImg10.src = badge10URL;
                streakImg10.alt = "10-day streak";
                streakImg10.classList.add("streak-img");
                streakImg10.onclick = function() {
                    openModal(this);
                };
                streakCell10.appendChild(streakImg10);
            }

            if (checkStreak(filteredDates, 30)) {
                const streakImg30 = document.createElement("img");
                streakImg30.src = badge30URL;
                streakImg30.alt = "30-day streak";
                streakImg30.classList.add("streak-img");
                streakImg30.onclick = function() {
                    openModal(this);
                };
                streakCell30.appendChild(streakImg30);
            }
        });

    } catch (error) {
        console.error("Error loading data: ", error);
    }
}

function checkStreak(dates, streakLength) {
    if (dates.length < streakLength) return false;
    
    // Remove duplicate dates that might be in the array
    const uniqueDates = [];
    const dateMap = new Map();
    
    dates.forEach(date => {
        const dateString = date.toISOString().split('T')[0];
        if (!dateMap.has(dateString)) {
            dateMap.set(dateString, true);
            uniqueDates.push(date);
        }
    });
    
    // Sort dates to ensure they are in chronological order
    uniqueDates.sort((a, b) => a - b);
    
    let currentStreak = 1;
    let maxStreak = 1;
    
    for (let i = 1; i < uniqueDates.length; i++) {
        const dayDiff = (uniqueDates[i] - uniqueDates[i-1]) / (1000 * 60 * 60 * 24);
        
        if (dayDiff === 1) {
            // Consecutive day found
            currentStreak++;
            maxStreak = Math.max(maxStreak, currentStreak);
        } else if (dayDiff > 1) {
            // Streak broken
            currentStreak = 1;
        }
        // If dayDiff is 0 (same day), we already handled it with uniqueDates
    }
    
    return maxStreak >= streakLength;
}

function openModal(img) {
    const modal = document.getElementById("myModal");
    const modalImg = document.getElementById("img01");
    const captionText = document.getElementById("caption");

    modal.style.display = "block";
    modalImg.src = img.src;
    captionText.innerHTML = img.alt;

    const span = document.getElementsByClassName("close")[0];
    span.onclick = function() {
        modal.style.display = "none";
    };
}

// Call generateTable with start and end dates
document.addEventListener("DOMContentLoaded", () => {
    generateTable(START_DATE, END_DATE);
});
</script>
</body>
</html>
