<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Push-up Accountability Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f8ff;
      padding: 20px;
    }
    h3 {
      color: #0020A9;
    }
    table {
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 2px solid #1e90ff;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #1e90ff;
      color: white;
    }
    .completed { background-color: #90ee90; }
    .timestamp {
      font-size: 0.8em;
      color: #666;
      margin-top: 5px;
    }
    .not-checked {
      cursor: pointer;
    }
    .header {
      display: flex;
      align-items: center;
    }
    .logo {
      max-width: 50px;
      margin-right: 20px;
    }
    .small-dark-text {
      font-size: 0.8em;
      color: #333; /* Very dark grey */
    }
    .tally-row, .tally-column {
      font-weight: bold;
      background-color: #e0ffff;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="https://raw.githubusercontent.com/victordelrosal/fivePushUps/main/b-logo.png" alt="Logo" class="logo">
    <h3>Select ✅ for each day you complete five (5) push-ups<br> 
    <span class="small-dark-text">Extra push-ups don't count towards future days</span></h3>
  </div>

  <table id="pushup-tracker">
    <thead>
      <tr>
        <th>Player</th>
        <!-- Dates dynamically generated -->
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      <!-- Player rows dynamically generated -->
    </tbody>
    <tfoot>
      <tr>
        <th></th>
        <!-- Daily totals dynamically generated -->
        <th></th>
      </tr>
    </tfoot>
  </table>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, doc, setDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAtg-_5eLD-Prs74zTnCj4HjQQfnssdfP8",
      authDomain: "fivepushups-d5d82.firebaseapp.com",
      projectId: "fivepushups-d5d82",
      storageBucket: "fivepushups-d5d82.appspot.com",
      messagingSenderId: "472818589501",
      appId: "1:472818589501:web:ef6402c4e19842c0e86f54",
      measurementId: "G-TJ5VSMC86Y"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log("Firebase initialized");

    function confirmCheck(checkbox, name, dateString) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const checkDate = new Date(dateString);

      if (checkDate.toDateString() !== today.toDateString()) {
        alert("You can only check off today's date.");
        checkbox.checked = false;
        return;
      }

      if (confirm(`I, ${name}, confirm that I have completed five or more push-ups today, ${dateString}.`)) {
        checkbox.disabled = true;

        const checkMark = document.createElement("span");
        checkMark.textContent = "✅";
        checkbox.parentElement.replaceChild(checkMark, checkbox);
        
        const timestamp = new Date().toLocaleString();
        const timestampElement = document.createElement("div");
        timestampElement.classList.add("timestamp");
        timestampElement.textContent = `Confirmed at: ${timestamp}`;
        checkMark.parentElement.appendChild(timestampElement);

        console.log(`${name} confirmed 5 push-ups on ${dateString} at ${timestamp}`);
        checkMark.parentElement.classList.add("completed");

        // Save to Firestore
        setDoc(doc(db, "pushups", `${name}_${dateString.replace(/\//g, '-')}`), {
          name: name,
          date: dateString,
          timestamp: timestamp
        }).then(() => {
          console.log("Data successfully written!");
          updateTallies();
        }).catch((error) => {
          console.error("Error writing document: ", error);
        });
      } else {
        checkbox.checked = false;
      }
    }

    function generateTable(startDate, endDate) {
      const table = document.getElementById("pushup-tracker");
      if (!table) {
        console.error("Table element not found");
        return;
      }

      const players = [
        { name: "Adam", idPrefix: "adam" },
        { name: "Colin", idPrefix: "colin" },
        { name: "Colm", idPrefix: "colm" },
        { name: "Jamie", idPrefix: "jamie" },
        { name: "JP", idPrefix: "jp" },
        { name: "Leo", idPrefix: "leo" },
        { name: "Mark", idPrefix: "mark" },
        { name: "Mervyn", idPrefix: "mervyn" },
        { name: "Nathan", idPrefix: "nathan" },
        { name: "Patrick", idPrefix: "patrick" },
        { name: "Seamus", idPrefix: "seamus" },
        { name: "SteveH", idPrefix: "steveh" },
        { name: "SteveJ", idPrefix: "stevej" },
        { name: "Victor", idPrefix: "victor" }
      ];

      const dates = generateDateRange(startDate, endDate);

      const headerRow = table.querySelector("thead tr");
      if (!headerRow) {
        console.error("Header row not found");
        return;
      }

      dates.forEach(date => {
        const parts = date.split("/");
        const formattedDate = `${parseInt(parts[1], 10)}/${parseInt(parts[0], 10)}`;
        const th = document.createElement("th");
        th.textContent = formattedDate;
        headerRow.appendChild(th);
      });

      const overallTotalTh = document.createElement("th");
      overallTotalTh.textContent = "Overall Total";
      headerRow.appendChild(overallTotalTh);

      const tbody = table.querySelector("tbody");
      if (!tbody) {
        console.error("Table body not found");
        return;
      }

      players.forEach(player => {
        const row = document.createElement("tr");
        const playerName = document.createElement("td");
        playerName.textContent = player.name;
        row.appendChild(playerName);

        dates.forEach(date => {
          const [month, day, year] = date.split("/");
          const checkboxId = `${player.idPrefix}-${month}-${day}-${year}`;
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = checkboxId;
          checkbox.onclick = () => confirmCheck(checkbox, player.name, date);
          const td = document.createElement("td");
          td.appendChild(checkbox);
          row.appendChild(td);
        });

        const playerTotalTd = document.createElement("td");
        playerTotalTd.id = `${player.idPrefix}-total`;
        row.appendChild(playerTotalTd);

        tbody.appendChild(row);
      });

      const footerRow = table.querySelector("tfoot tr");
      if (!footerRow) {
        console.error("Footer row not found");
        return;
      }

      dates.forEach((date, index) => {
        const dailyTotalTd = document.createElement("td");
        dailyTotalTd.id = `daily-total-${index}`;
        footerRow.appendChild(dailyTotalTd);
      });

      const overallTotalTd = document.createElement("td");
      overallTotalTd.id = `overall-total`;
      footerRow.appendChild(overallTotalTd);

      disableFutureDates();
      loadData();
    }

    function disableFutureDates() {
      const today = new Date();
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');

      checkboxes.forEach(checkbox => {
        const [_, month, day, year] = checkbox.id.split("-");
        const checkDate = new Date(`${month}/${day}/${year}`);

        if (checkDate > today) {
          checkbox.disabled = true;
        }
      });
    }

    function generateDateRange(startDate, endDate) {
      const dates = [];
      const currentDate = new Date(startDate);
      const end = new Date(endDate);

      while (currentDate <= end) {
        const day = currentDate.getDate();
        const month = currentDate.getMonth() + 1;
        const year = currentDate.getFullYear();
        dates.push(`${month}/${day}/${year}`);
        currentDate.setDate(currentDate.getDate() + 1);
      }

      return dates;
    }

    async function loadData() {
      try {
        const querySnapshot = await getDocs(collection(db, "pushups"));
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const name = data.name;
          const date = data.date;
          const timestamp = data.timestamp;

          console.log("Loaded data:", data);  // Debugging statement

          const formattedDate = date.replace(/\//g, '-');
          const checkboxId = `${name.toLowerCase()}-${formattedDate}`;
          console.log("Checkbox ID:", checkboxId);  // Debugging statement

          const checkbox = document.getElementById(checkboxId);

          if (checkbox) {
            const checkMark = document.createElement("span");
            checkMark.textContent = "✅";
            checkbox.parentElement.replaceChild(checkMark, checkbox);

            const timestampElement = document.createElement("div");
            timestampElement.classList.add("timestamp");
            timestampElement.textContent = `Confirmed at: ${timestamp}`;
            checkMark.parentElement.appendChild(timestampElement);

            checkMark.parentElement.classList.add("completed");
          } else {
            console.error("Checkbox not found for ID:", checkboxId);  // Debugging statement
          }
        });
        console.log("Data successfully loaded!");
        updateTallies();
      } catch (error) {
        console.error("Error loading data: ", error);
      }
    }

    function updateTallies() {
      const rows = document.querySelectorAll("#pushup-tracker tbody tr");
      const datesCount = document.querySelectorAll("#pushup-tracker thead th").length - 2; // Exclude Player and Total columns
      let overallTotal = 0;

      // Update player totals
      rows.forEach(row => {
        let playerTotal = 0;
        for (let i = 1; i <= datesCount; i++) { // Start from 1 to skip the player name
          const cell = row.cells[i];
          if (cell && cell.querySelector("span")) {
            playerTotal++;
          }
        }
        const playerTotalCell = row.cells[datesCount + 1]; // The last cell in the row
        playerTotalCell.textContent = playerTotal;
        overallTotal += playerTotal;
      });

      // Update daily totals
      for (let i = 0; i < datesCount; i++) {
        let dailyTotal = 0;
        rows.forEach(row => {
          const cell = row.cells[i + 1]; // Start from 1 to skip the player name
          if (cell && cell.querySelector("span")) {
            dailyTotal++;
          }
        });
        const dailyTotalCell = document.getElementById(`daily-total-${i}`);
        dailyTotalCell.textContent = dailyTotal;
      }

      // Update overall total
      const overallTotalCell = document.getElementById("overall-total");
      overallTotalCell.textContent = overallTotal;
    }

    // Call generateTable with start and end dates
    document.addEventListener("DOMContentLoaded", () => {
      generateTable("2024-07-08", "2024-08-21");
    });
  </script>
</body>
</html>
